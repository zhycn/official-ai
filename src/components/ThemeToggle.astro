---
// 双模式主题切换组件：点击在亮色和暗色之间切换
import { COLORS } from '../utils/constants';
---

<button
  id="theme-toggle"
  type="button"
  class="theme-toggle-btn btn-hover-primary p-2 rounded-lg text-gray-600 dark:text-gray-400 transition-colors duration-200 relative touch-manipulation"
  aria-label="Toggle theme"
>
  <!-- 亮色模式图标 -->
  <svg id="theme-icon-light" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
  </svg>
  <!-- 暗色模式图标 -->
  <svg id="theme-icon-dark" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
  </svg>
</button>

<script is:inline>
  (function() {
    'use strict';
    
    // 只支持 light 和 dark 两种模式
    const themes = ['light', 'dark'];
    
    // 获取当前主题
    function getTheme() {
      try {
        const theme = localStorage.getItem('theme');
        // 如果之前是 auto，转换为 light
        if (theme === 'auto' || !theme) {
          return 'light';
        }
        return theme === 'dark' ? 'dark' : 'light';
      } catch (e) {
        return 'light';
      }
    }
    
    // 设置主题
    function setTheme(theme) {
      try {
        localStorage.setItem('theme', theme);
      } catch (e) {
        // localStorage 不可用时静默失败
      }
    }
    
    // 应用主题到 DOM（无闪动版本）
    function applyTheme(theme) {
      const html = document.documentElement;
      
      // 暂时禁用过渡动画
      const disableStyle = document.createElement('style');
      disableStyle.id = 'theme-transition-disable';
      disableStyle.textContent = '* { transition: none !important; }';
      document.head.appendChild(disableStyle);
      
      // 同步更新主题类
      if (theme === 'dark') {
        html.classList.add('dark');
        html.style.colorScheme = 'dark';
      } else {
        html.classList.remove('dark');
        html.style.colorScheme = 'light';
      }
      
      // 强制同步渲染
      html.offsetHeight;
      
      // 恢复过渡动画（延迟一帧）
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          const style = document.getElementById('theme-transition-disable');
          if (style) {
            style.remove();
          }
        });
      });
    }
    
    // 更新图标显示
    function updateIcon(theme) {
      const lightIcon = document.getElementById('theme-icon-light');
      const darkIcon = document.getElementById('theme-icon-dark');
      
      // 隐藏所有图标
      if (lightIcon) lightIcon.classList.add('hidden');
      if (darkIcon) darkIcon.classList.add('hidden');
      
      // 显示对应图标
      if (theme === 'light' && lightIcon) {
        lightIcon.classList.remove('hidden');
      } else if (theme === 'dark' && darkIcon) {
        darkIcon.classList.remove('hidden');
      }
    }
    
    // 切换主题
    function toggleTheme() {
      const current = getTheme();
      const nextTheme = current === 'light' ? 'dark' : 'light';
      
      setTheme(nextTheme);
      applyTheme(nextTheme);
      updateIcon(nextTheme);
      
      // 触发事件
      try {
        window.dispatchEvent(new CustomEvent('themechange', { 
          detail: { theme: nextTheme } 
        }));
      } catch (e) {
        // 事件派发失败时静默失败
      }
    }
    
    // 初始化主题切换按钮
    function initToggle() {
      const button = document.getElementById('theme-toggle');
      if (!button) {
        setTimeout(initToggle, 100);
        return;
      }
      
      // 使用 onclick 绑定事件
      button.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleTheme();
        return false;
      };
      
      // 初始化图标显示
      const theme = getTheme();
      updateIcon(theme);
    }
    
    // 初始化主题
    function initTheme() {
      const theme = getTheme();
      applyTheme(theme);
      updateIcon(theme);
    }
    
    // 导出到全局
    if (typeof window !== 'undefined') {
      window.__themeManager = {
        getTheme: getTheme,
        setTheme: setTheme,
        applyTheme: applyTheme,
        toggleTheme: toggleTheme
      };
    }
    
    // 执行初始化
    initTheme();
    
    // 初始化按钮
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initToggle, 100);
      });
    } else {
      setTimeout(initToggle, 100);
    }
  })();
</script>
