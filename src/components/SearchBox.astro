---
// Google风格的搜索框组件
import { getLocaleFromAstro, t } from '../i18n/locales';

interface Props {
  variant?: 'desktop' | 'mobile';
}

const { variant = 'desktop' } = Astro.props;
// 使用安全函数获取语言，避免在预渲染模式下访问 Astro.request
const locale = getLocaleFromAstro();
const placeholder = t('search.placeholder', locale);

// 根据 variant 生成唯一的 ID
const idPrefix = variant === 'mobile' ? 'mobile-' : '';
const containerId = `${idPrefix}search-container`;
const inputId = `${idPrefix}search-input`;
const clearId = `${idPrefix}search-clear`;
const suggestionsId = `${idPrefix}search-suggestions`;
const suggestionsListId = `${idPrefix}suggestions-list`;
---

<div class="relative w-full" id={containerId}>
  <div class="relative group">
    <!-- 搜索图标 -->
    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none z-10">
      <svg class="h-5 w-5 text-gray-400 dark:text-gray-500 group-focus-within:text-[#FF5A50] dark:group-focus-within:text-[#FF6B60] transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
    
    <!-- 搜索输入框 -->
    <input
      id={inputId}
      name="search"
      type="search"
      placeholder={placeholder}
      autocomplete="off"
      class="search-input block w-full pl-12 pr-20 sm:pr-24 py-3 text-sm sm:text-base border-0 rounded-full bg-gray-100 dark:bg-gray-800/50 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:bg-white dark:focus:bg-gray-800 transition-all duration-200"
    />
    
    <!-- 右侧操作区 -->
    <div class="absolute inset-y-0 right-0 flex items-center pr-3 gap-1.5">
      <!-- 清除按钮 -->
      <button
        id={clearId}
        type="button"
        class="hidden p-1.5 text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200 active:scale-95 touch-manipulation"
        aria-label={locale === 'zh' ? '清除搜索' : 'Clear search'}
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      
      <!-- 键盘快捷键提示 -->
      <kbd class="hidden sm:flex items-center px-2 py-1 text-xs font-medium text-gray-500 dark:text-gray-400 bg-white/60 dark:bg-gray-700/60 border border-gray-300/40 dark:border-gray-600/40 rounded-md shadow-sm">⌘K</kbd>
    </div>
  </div>
  
  <!-- 搜索建议下拉框 -->
  <div
    id={suggestionsId}
    class="hidden absolute top-full left-0 right-0 mt-1.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl max-h-96 overflow-y-auto z-[60]"
    style="box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);"
  >
    <div id={suggestionsListId} class="py-1">
      <!-- 建议项将动态插入这里 -->
    </div>
  </div>
</div>

<style>
  #search-suggestions,
  #mobile-search-suggestions {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
  }
  
  #search-suggestions::-webkit-scrollbar,
  #mobile-search-suggestions::-webkit-scrollbar {
    width: 8px;
  }
  
  #search-suggestions::-webkit-scrollbar-track,
  #mobile-search-suggestions::-webkit-scrollbar-track {
    background: transparent;
  }
  
  #search-suggestions::-webkit-scrollbar-thumb,
  #mobile-search-suggestions::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 4px;
  }
  
  #search-suggestions::-webkit-scrollbar-thumb:hover,
  #mobile-search-suggestions::-webkit-scrollbar-thumb:hover {
    background-color: rgba(156, 163, 175, 0.7);
  }
  
  .suggestion-item {
    transition: all 0.15s ease;
    position: relative;
    border-radius: 0.5rem;
    margin: 0 0.5rem;
  }
  
  .suggestion-item:hover {
    background-color: rgba(255, 90, 80, 0.08);
    transform: translateX(2px);
  }
  
  .dark .suggestion-item:hover {
    background-color: rgba(255, 107, 96, 0.12);
  }
  
  .suggestion-item.active,
  .suggestion-item[aria-selected="true"] {
    background-color: rgba(255, 90, 80, 0.12);
    outline: 2px solid rgba(255, 90, 80, 0.2);
    outline-offset: -2px;
  }
  
  .dark .suggestion-item.active,
  .dark .suggestion-item[aria-selected="true"] {
    background-color: rgba(255, 107, 96, 0.18);
    outline-color: rgba(255, 107, 96, 0.3);
  }
  
  /* 简化的搜索建议项布局 */
  .suggestion-content {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
  }
  
  .suggestion-icon {
    flex-shrink: 0;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .suggestion-text {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 1px;
  }
  
  .suggestion-title {
    font-size: 14px;
    line-height: 1.4;
    font-weight: 400;
  }
  
  .suggestion-description {
    font-size: 12px;
    line-height: 1.3;
    opacity: 0.7;
  }
  
  .highlight {
    font-weight: 600;
    color: rgb(249, 115, 22);
    background-color: rgba(249, 115, 22, 0.1);
    padding: 0 2px;
    border-radius: 2px;
  }
  
  .dark .highlight {
    color: rgb(251, 146, 60);
    background-color: rgba(251, 146, 60, 0.15);
  }
  
  /* Google风格的搜索框聚焦效果 - 使用整体阴影，无边框 */
  .search-input {
    box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28);
    outline: none !important;
    border: none !important;
  }
  
  .search-input:hover {
    box-shadow: 0 2px 8px rgba(32, 33, 36, 0.3);
  }
  
  /* 浅色主题聚焦样式 */
  .search-input:focus,
  .search-input:focus-visible {
    box-shadow: 0 2px 8px rgba(32, 33, 36, 0.3) !important;
    background-color: white !important;
    color: rgb(17, 24, 39) !important;
    outline: none !important;
    border: none !important;
  }
  
  /* 深色主题基础样式 */
  .dark .search-input {
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.4);
  }
  
  .dark .search-input:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  }
  
  /* 浅色主题聚焦样式 - ProductHunt 橙色 */
  .search-input:focus,
  .search-input:focus-visible {
    box-shadow: 0 2px 8px rgba(255, 90, 80, 0.25) !important;
    background-color: white !important;
    color: rgb(17, 24, 39) !important;
    outline: none !important;
    border: none !important;
  }
  
  /* 深色主题聚焦样式 - ProductHunt 橙色 */
  .dark .search-input:focus,
  .dark .search-input:focus-visible {
    box-shadow: 0 4px 12px rgba(255, 107, 96, 0.3) !important;
    background-color: rgb(31, 41, 55) !important;
    color: rgb(229, 231, 235) !important;
    outline: none !important;
    border: none !important;
  }
  
  .dark .search-input:focus::placeholder {
    color: rgb(156, 163, 175) !important;
  }
</style>
