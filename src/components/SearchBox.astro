---
// Google风格的搜索框组件
import { getLocaleFromAstro, t } from '../i18n/locales';
import { COLORS } from '../utils/constants';

interface Props {
  variant?: 'desktop' | 'mobile';
}

const { variant = 'desktop' } = Astro.props;
// 使用安全函数获取语言，避免在预渲染模式下访问 Astro.request
const locale = getLocaleFromAstro();
const placeholder = t('search.placeholder', locale);

// 根据 variant 生成唯一的 ID
const idPrefix = variant === 'mobile' ? 'mobile-' : '';
const containerId = `${idPrefix}search-container`;
const inputId = `${idPrefix}search-input`;
const clearId = `${idPrefix}search-clear`;
const suggestionsId = `${idPrefix}search-suggestions`;
const suggestionsListId = `${idPrefix}suggestions-list`;
---

<div class="relative w-full" id={containerId}>
  <div class="relative group">
    <!-- 搜索图标 -->
    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none z-10">
      <svg class="search-icon h-5 w-5 text-gray-400 dark:text-gray-500 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
    
    <!-- 搜索输入框 -->
    <input
      id={inputId}
      name="search"
      type="text"
      placeholder={placeholder}
      autocomplete="off"
      class="search-input block w-full pl-12 pr-20 sm:pr-24 py-3 text-sm sm:text-base border-0 rounded-full bg-gray-100 dark:bg-gray-800/50 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none transition-all duration-200"
    />
    
    <!-- 右侧操作区 -->
    <div class="absolute inset-y-0 right-0 flex items-center pr-3 gap-1.5">
      <!-- 清除按钮 -->
      <button
        id={clearId}
        type="button"
        class="hidden p-1.5 text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200 active:scale-95 touch-manipulation"
        aria-label={t('search.clear', locale)}
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      
      <!-- 键盘快捷键提示 -->
      <kbd class="hidden sm:flex items-center px-2 py-1 text-xs font-medium text-gray-500 dark:text-gray-400 bg-white/60 dark:bg-gray-700/60 border border-gray-300/40 dark:border-gray-600/40 rounded-md shadow-sm">⌘K</kbd>
    </div>
  </div>
  
  <!-- 搜索建议下拉框 -->
  <div
    id={suggestionsId}
    class="search-suggestions-container hidden absolute top-full left-0 right-0 mt-1.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl max-h-96 overflow-y-auto z-[60]"
    role="listbox"
    aria-label={t('search.suggestions', locale) || 'Search suggestions'}
    aria-expanded="false"
  >
    <div id={suggestionsListId} class="py-1" role="list">
      <!-- 建议项将动态插入这里 -->
    </div>
  </div>
</div>

<style>
  #search-suggestions,
  #mobile-search-suggestions {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
  }
  
  #search-suggestions::-webkit-scrollbar,
  #mobile-search-suggestions::-webkit-scrollbar {
    width: 8px;
  }
  
  #search-suggestions::-webkit-scrollbar-track,
  #mobile-search-suggestions::-webkit-scrollbar-track {
    background: transparent;
  }
  
  #search-suggestions::-webkit-scrollbar-thumb,
  #mobile-search-suggestions::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 4px;
  }
  
  #search-suggestions::-webkit-scrollbar-thumb:hover,
  #mobile-search-suggestions::-webkit-scrollbar-thumb:hover {
    background-color: rgba(156, 163, 175, 0.7);
  }
  
  .suggestion-item {
    transition: background-color 0.1s ease;
    position: relative;
    margin: 0;
    border-radius: 0;
  }
  
  /* Google风格悬停效果 */
  .suggestion-item:hover {
    background-color: rgba(32, 33, 36, 0.05);
  }
  
  .dark .suggestion-item:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }
  
  /* Google风格选中效果 */
  .suggestion-item.active,
  .suggestion-item[aria-selected="true"] {
    background-color: rgba(32, 33, 36, 0.08);
  }
  
  .dark .suggestion-item.active,
  .dark .suggestion-item[aria-selected="true"] {
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  /* 搜索建议项布局 - Google风格：图标在前，文字在后，单行显示 */
  .suggestion-content {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    min-height: 40px; /* 确保有足够的高度 */
  }
  
  .suggestion-icon {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgb(95, 99, 104); /* Google搜索图标颜色 */
  }
  
  .dark .suggestion-icon {
    color: rgb(154, 160, 166); /* 深色模式图标颜色 */
  }
  
  .suggestion-title {
    flex: 1;
    min-width: 0;
    font-size: 15px;
    line-height: 1.5;
    font-weight: 400;
    color: rgb(32, 33, 36); /* Google搜索文字颜色 */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap; /* 单行显示，不换行 */
  }
  
  .dark .suggestion-title {
    color: rgb(232, 234, 237); /* 深色模式文字颜色 */
  }
  
  /* Google风格高亮 - 使用ProductHunt橙色 */
  .highlight {
    font-weight: 500;
    color: var(--theme-primary);
    background-color: transparent;
    padding: 0;
  }
  
  .dark .highlight {
    color: var(--theme-primary-dark);
    background-color: transparent;
  }
  
  /* Google风格的搜索框聚焦效果 - 使用整体阴影，无边框 */
  .search-input {
    box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28);
    outline: none !important;
    border: none !important;
  }
  
  .search-input:hover {
    box-shadow: 0 2px 8px rgba(32, 33, 36, 0.3);
  }
  
  /* 浅色主题聚焦样式 - ProductHunt 橙色 */
  .search-input:focus,
  .search-input:focus-visible {
    box-shadow: var(--theme-shadow-focus) !important;
    background-color: white !important;
    color: rgb(17, 24, 39) !important;
    outline: none !important;
    border: none !important;
  }
  
  /* 深色主题基础样式 */
  .dark .search-input {
    box-shadow: var(--theme-shadow-default);
  }
  
  .dark .search-input:hover {
    box-shadow: var(--theme-shadow-hover);
  }
  
  /* 深色主题聚焦样式 - ProductHunt 橙色，保持与建议框一致的背景 */
  .dark .search-input:focus,
  .dark .search-input:focus-visible {
    box-shadow: var(--theme-shadow-focus) !important;
    background-color: rgb(31, 41, 55) !important; /* 与建议框背景一致 dark:bg-gray-800 */
    color: rgb(229, 231, 235) !important; /* 与建议框文字一致 dark:text-gray-100 */
    outline: none !important;
    border: none !important;
  }
  
  .dark .search-input:focus::placeholder {
    color: rgb(156, 163, 175) !important; /* 与建议框占位符一致 dark:placeholder-gray-400 */
  }
  
  /* 确保输入框文字颜色在深色模式下正确 */
  .dark .search-input {
    color: rgb(229, 231, 235);
    background-color: rgb(31, 41, 55); /* 与建议框背景一致 */
  }
  
  /* 确保输入框在非聚焦状态下也有正确的背景色 */
  .dark .search-input:not(:focus):not(:focus-visible) {
    background-color: rgba(31, 41, 55, 0.5);
  }
  
  /* 搜索图标聚焦时变色 */
  .group:focus-within .search-icon {
    color: var(--theme-primary);
  }
  
  .dark .group:focus-within .search-icon {
    color: var(--theme-primary-dark);
  }
</style>
