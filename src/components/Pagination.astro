---
import { getLocaleFromAstro, t, clientTranslations } from '../i18n/locales';
import { COLORS } from '../utils/constants';

interface Props {
  currentPage: number;
  totalPages: number;
}

const { currentPage, totalPages } = Astro.props;
// 使用安全函数获取语言，避免在预渲染模式下访问 Astro.request
const locale = getLocaleFromAstro();
---

<div class="flex flex-col sm:flex-row items-center justify-between gap-4 sm:gap-0 mt-6 sm:mt-8 pt-4 sm:pt-6 border-t border-gray-200/60 dark:border-gray-800/60">
  <div id="pagination-page-info" class="text-sm sm:text-base font-medium text-gray-600 dark:text-gray-400">
    {t('pagination.page', locale)} <span class="font-semibold text-gray-900 dark:text-white">{currentPage}</span> / <span class="font-semibold text-gray-900 dark:text-white">{totalPages}</span>
  </div>
  <div class="flex gap-3">
    <button
      id="prev-page"
      disabled={currentPage === 1}
      class={`inline-flex items-center justify-center px-4 py-2 sm:px-5 sm:py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg hover:bg-[${COLORS.PRODUCTHUNT_LIGHT}] dark:hover:bg-[${COLORS.PRODUCTHUNT}]/10 hover:border-[${COLORS.PRODUCTHUNT}] dark:hover:border-[${COLORS.PRODUCTHUNT_DARK}] hover:text-[${COLORS.PRODUCTHUNT}] dark:hover:text-[${COLORS.PRODUCTHUNT_DARK}] transition-all duration-200 hover:shadow-sm active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-gray-300 disabled:hover:text-gray-700 disabled:hover:shadow-none dark:disabled:hover:bg-gray-800 dark:disabled:hover:border-gray-700 dark:disabled:hover:text-gray-300 touch-manipulation`}
    >
      <span id="prev-page-text">{t('pagination.prev', locale)}</span>
    </button>
    <button
      id="next-page"
      disabled={currentPage === totalPages}
      class={`inline-flex items-center justify-center px-4 py-2 sm:px-5 sm:py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg hover:bg-[${COLORS.PRODUCTHUNT_LIGHT}] dark:hover:bg-[${COLORS.PRODUCTHUNT}]/10 hover:border-[${COLORS.PRODUCTHUNT}] dark:hover:border-[${COLORS.PRODUCTHUNT_DARK}] hover:text-[${COLORS.PRODUCTHUNT}] dark:hover:text-[${COLORS.PRODUCTHUNT_DARK}] transition-all duration-200 hover:shadow-sm active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-gray-300 disabled:hover:text-gray-700 disabled:hover:shadow-none dark:disabled:hover:bg-gray-800 dark:disabled:hover:border-gray-700 dark:disabled:hover:text-gray-300 touch-manipulation`}
    >
      <span id="next-page-text">{t('pagination.next', locale)}</span>
    </button>
  </div>
</div>

<script define:vars={{ clientTranslations }}>
  // 获取当前语言（客户端）
  function getClientLocale() {
    try {
      const saved = localStorage.getItem('locale');
      if (saved === 'zh' || saved === 'en') {
        return saved;
      }
      const browserLang = navigator.language || navigator.userLanguage;
      if (browserLang.startsWith('zh')) return 'zh';
      if (browserLang.startsWith('en')) return 'en';
    } catch (e) {
      // localStorage 不可用时使用默认值
    }
    return 'zh';
  }
  
  // HTML 转义函数
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // 国际化更新器类
  class I18nUpdater {
    constructor(translations) {
      this.translations = translations;
    }
    
    updatePagination(locale) {
      const t = this.translations[locale] || this.translations['zh'];
      
      const pageInfo = document.getElementById('pagination-page-info');
      if (pageInfo) {
        const match = pageInfo.textContent?.match(/(\d+)\s*\/\s*(\d+)/);
        if (match) {
          pageInfo.innerHTML = `${escapeHtml(t.pagination.page)} <span class="font-semibold text-gray-900 dark:text-white">${match[1]}</span> / <span class="font-semibold text-gray-900 dark:text-white">${match[2]}</span>`;
        }
      }
      
      const prevText = document.getElementById('prev-page-text');
      if (prevText) {
        prevText.textContent = t.pagination.prev;
      }
      
      const nextText = document.getElementById('next-page-text');
      if (nextText) {
        nextText.textContent = t.pagination.next;
      }
    }
  }
  
  const i18nUpdater = new I18nUpdater(clientTranslations);
  
  // 更新分页文本
  function updatePaginationText(locale) {
    i18nUpdater.updatePagination(locale);
  }
  
  // 监听语言变更事件
  window.addEventListener('localechange', function(e) {
    const locale = (e.detail && e.detail.locale) ? e.detail.locale : getClientLocale();
    updatePaginationText(locale);
  });
  
  // 初始化时更新文本（处理客户端渲染）
  if (typeof window !== 'undefined') {
    updatePaginationText(getClientLocale());
  }
</script>
