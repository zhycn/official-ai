---
// 语言切换组件
import { getLocaleFromRequest, t, clientTranslations } from '../i18n/locales';

const locale = getLocaleFromRequest(Astro.request);
const safeLocale: 'zh' | 'en' = locale === 'zh' || locale === 'en' ? locale : 'zh';
const languageConfig = clientTranslations[safeLocale].language;
---

<div class="relative">
  <button
    id="language-toggle"
    type="button"
    class="p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:text-[#FF5A50] dark:hover:text-[#FF6B60] hover:bg-[#FFF5F4] dark:hover:bg-[#FF5A50]/10 transition-colors duration-200 touch-manipulation flex items-center justify-center"
    aria-label={languageConfig.ariaLabel}
    title={languageConfig.toggle}
  >
    <!-- 语言图标 -->
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
    </svg>
    <!-- 语言文字（移动端隐藏） -->
    <span id="language-display" class="ml-1.5 hidden sm:inline-block text-xs font-medium">{languageConfig.display[safeLocale]}</span>
  </button>
</div>

<script define:vars={{ clientTranslations }} is:inline>
  (function() {
    // 获取当前语言
    function getLocale() {
      return localStorage.getItem('locale') || 'zh';
    }
    
    // 设置语言
    function setLocale(locale) {
      localStorage.setItem('locale', locale);
      updateLanguageDisplay(locale);
      
      // 触发语言变更事件
      window.dispatchEvent(new CustomEvent('localechange', { 
        detail: { locale: locale } 
      }));
      
      // 更新页面文本（不刷新页面）
      updatePageText(locale);
    }
    
    // 更新页面文本
    function updatePageText(locale) {
      // @ts-ignore - locale is a valid key
      const t = clientTranslations[locale] || clientTranslations['zh'];
      
      // 更新提交按钮
      const submitBtn = document.querySelector('[data-i18n="nav.submit"]');
      if (submitBtn) submitBtn.textContent = t.nav.submit;
      
      // 更新标题（如果需要）
      const title = document.querySelector('h1');
      if (title && title.textContent === 'Official AI') {
        title.textContent = t.page.title;
      }
      
      // 更新统计信息（检查是否在搜索状态）
      const statsText = document.getElementById('stats-text');
      if (statsText) {
        const totalCount = document.getElementById('total-count')?.textContent || '0';
        const searchInput = document.getElementById('search-input');
        const isSearching = searchInput && searchInput.value.trim() !== '';
        const statsLabel = isSearching ? t.page.statsSearch : t.page.stats;
        statsText.innerHTML = `${statsLabel} · <span id="total-count" class="font-semibold text-gray-900 dark:text-white">${totalCount}</span> ${t.page.items}`;
      }
      
      // 更新分页文本
      const pageInfo = document.querySelector('#pagination-container .text-sm');
      if (pageInfo) {
        const match = pageInfo.textContent.match(/(\d+)\s*\/\s*(\d+)/);
        if (match) {
          pageInfo.innerHTML = `${t.pagination.page} <span class="text-gray-900 dark:text-white">${match[1]}</span> / <span class="text-gray-900 dark:text-white">${match[2]}</span>`;
        }
      }
      
      const prevBtn = document.getElementById('prev-page');
      if (prevBtn) {
        const prevTextEl = prevBtn.querySelector('#prev-page-text');
        if (prevTextEl) prevTextEl.textContent = t.pagination.prev;
      }
      
      const nextBtn = document.getElementById('next-page');
      if (nextBtn) {
        const nextTextEl = nextBtn.querySelector('#next-page-text');
        if (nextTextEl) nextTextEl.textContent = t.pagination.next;
      }
      
      // 更新搜索框占位符
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.placeholder = t.search.placeholder;
      }
      
      // 更新清除按钮
      const clearBtn = document.getElementById('search-clear');
      if (clearBtn) {
        clearBtn.setAttribute('aria-label', t.search.clear);
      }
    }
    
    // 更新语言显示
    function updateLanguageDisplay(locale) {
      // @ts-ignore - locale is a valid key
      const languageConfig = clientTranslations[locale]?.language || clientTranslations['zh'].language;
      
      const display = document.getElementById('language-display');
      if (display) {
        display.textContent = languageConfig.display[locale] || languageConfig.display.zh;
      }
      
      // 更新按钮的 title 和 aria-label 属性
      const button = document.getElementById('language-toggle');
      if (button) {
        button.setAttribute('title', languageConfig.toggle);
        button.setAttribute('aria-label', languageConfig.ariaLabel);
      }
    }
    
    // 切换语言
    function toggleLanguage() {
      const currentLocale = getLocale();
      const nextLocale = currentLocale === 'zh' ? 'en' : 'zh';
      setLocale(nextLocale);
    }
    
    // 初始化
    function initLanguageToggle() {
      const languageToggle = document.getElementById('language-toggle');
      
      if (!languageToggle) {
        setTimeout(initLanguageToggle, 100);
        return;
      }
      
      // 显示当前语言
      updateLanguageDisplay(getLocale());
      
      // 绑定点击事件
      languageToggle.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleLanguage();
      });
    }
    
    // 确保在 DOM 加载后执行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initLanguageToggle, 50);
      });
    } else {
      setTimeout(initLanguageToggle, 50);
    }
  })();
</script>
