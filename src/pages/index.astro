---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import ToolCard from '../components/ToolCard.astro';
import Pagination from '../components/Pagination.astro';
import Footer from '../components/Footer.astro';
import toolsData from '../../public/data/tools.json';
import { getLocaleFromRequest, t, clientTranslations } from '../i18n/locales';

// 将翻译对象序列化为 JSON，以便在客户端使用
const translationsJSON = JSON.stringify(clientTranslations);

const ITEMS_PER_PAGE = 24;
const locale = getLocaleFromRequest(Astro.request);

// 从 URL 读取页码（服务端）
const urlPageParam = Astro.url.searchParams.get('page');
const initialPage = urlPageParam ? Math.max(1, parseInt(urlPageParam, 10)) : 1;
const totalPages = Math.ceil(toolsData.length / ITEMS_PER_PAGE);
const safePage = Math.min(initialPage, totalPages || 1);
const startIndex = (safePage - 1) * ITEMS_PER_PAGE;
const endIndex = startIndex + ITEMS_PER_PAGE;
const initialTools = toolsData.slice(startIndex, endIndex);
---

<Layout title="Skills - skill0">
  <div class="min-h-screen flex flex-col bg-linear-to-br from-gray-50 via-white to-gray-50/50 dark:from-gray-950 dark:via-gray-900 dark:to-gray-950/50">
    <Navbar />
    
    <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12 lg:py-16 w-full">
      <!-- 标题信息 -->
      <div class="mb-8 sm:mb-12">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white mb-3 sm:mb-4 tracking-tight leading-tight">
          {t('page.title', locale)}
        </h1>
        <p class="text-sm sm:text-base text-gray-500 dark:text-gray-400 mb-4 sm:mb-5 italic font-light">
          {t('page.subtitle', locale)}
        </p>
        <p class="text-base sm:text-lg text-gray-600 dark:text-gray-400 leading-relaxed">
          <span id="stats-text" class="inline-flex items-center gap-2">
            <span class="px-2.5 py-1 rounded-md bg-gray-100 dark:bg-gray-800 text-sm font-medium text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700">
              {t('page.stats', locale)}
            </span>
            <span id="total-count" class="font-semibold text-gray-900 dark:text-white">{toolsData.length}</span>
            <span>{t('page.items', locale)}</span>
          </span>
        </p>
      </div>

      <!-- 工具卡片列表 -->
      <div id="tools-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-5 lg:gap-6 mb-10 sm:mb-12">
        {initialTools.map((tool) => (
          <ToolCard
            id={tool.id}
            name={tool.name}
            description={tool.description}
            url={tool.url}
          />
        ))}
      </div>

      <!-- 分页 -->
      <div id="pagination-container">
        <Pagination
          currentPage={safePage}
          totalPages={totalPages}
        />
      </div>
    </main>

    <Footer />
  </div>
</Layout>

<script define:vars={{ toolsData, ITEMS_PER_PAGE, translationsJSON }}>
  // 使用从 locales.ts 导入的翻译
  const translations = JSON.parse(translationsJSON);
  
  // 获取当前语言
  function getLocale() {
    return localStorage.getItem('locale') || 'zh';
  }
  
  // 获取翻译（支持嵌套键，如 'page.stats'）
  function t(key) {
    const locale = getLocale();
    const keys = key.split('.');
    let value = translations[locale];
    
    for (const k of keys) {
      if (value == null || typeof value !== 'object') {
        return key;
      }
      value = value[k];
    }
    
    return typeof value === 'string' ? value : key;
  }
  
  // 使用动态导入加载 Fuse.js
  let Fuse;
  let currentPage = 1;
  let filteredTools = [...toolsData];
  let fuse;

  // 获取 URL 参数
  function getURLParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    const value = urlParams.get(name);
    return value ? parseInt(value, 10) : null;
  }

  // 更新 URL 参数（不刷新页面）
  function updateURLParam(name, value) {
    const url = new URL(window.location);
    if (value === null || value === undefined || value === 1) {
      // 如果是第一页或无效值，移除参数
      url.searchParams.delete(name);
    } else {
      url.searchParams.set(name, value.toString());
    }
    window.history.pushState({ page: value }, '', url);
  }

  // HTML 转义函数
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // 加载 Fuse.js（使用 CDN）
  function loadFuseJS() {
    return new Promise((resolve, reject) => {
      // 检查是否已经加载
      if (window.Fuse) {
        resolve(window.Fuse);
        return;
      }

      // 检查是否正在加载
      if (window.__fuseLoading) {
        window.__fuseLoading.then(() => {
          if (window.Fuse) {
            resolve(window.Fuse);
          } else {
            reject(new Error('Fuse.js not available'));
          }
        }).catch(reject);
        return;
      }

      // 创建加载 Promise
      window.__fuseLoading = new Promise((loadResolve, loadReject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.1.0/dist/fuse.min.js';
        script.async = true;
        script.crossOrigin = 'anonymous';
        
        const timeout = setTimeout(() => {
          loadReject(new Error('Fuse.js loading timeout'));
        }, 10000); // 10秒超时
        
        script.onload = () => {
          clearTimeout(timeout);
          // 等待一下确保 Fuse 已经挂载到 window
          setTimeout(() => {
            if (window.Fuse) {
              loadResolve(window.Fuse);
            } else {
              loadReject(new Error('Fuse.js loaded but not available on window'));
            }
          }, 100);
        };
        
        script.onerror = () => {
          clearTimeout(timeout);
          loadReject(new Error('Failed to load Fuse.js from CDN'));
        };
        
        document.head.appendChild(script);
      });

      window.__fuseLoading
        .then(() => {
          if (window.Fuse) {
            resolve(window.Fuse);
          } else {
            reject(new Error('Fuse.js not available'));
          }
        })
        .catch(reject);
    });
  }

  // 初始化 Fuse.js
  async function initFuse() {
    try {
      Fuse = await loadFuseJS();
      fuse = new Fuse(toolsData, {
        keys: ['name', 'description'],
        threshold: 0.3,
        includeScore: true,
      });
      console.log('Fuse.js initialized successfully');
      return true;
    } catch (error) {
      console.error('Failed to load Fuse.js:', error);
      return false;
    }
  }

  // 渲染工具卡片
  function renderTools(tools, page, updateURL = true, isSearching = false) {
    const container = document.getElementById('tools-container');
    const paginationContainer = document.getElementById('pagination-container');
    if (!container) return;

    // 如果工具列表为空，显示空状态并隐藏分页
    if (tools.length === 0) {
      const locale = getLocale();
      const emptyState = translations[locale]?.emptyState || translations.zh.emptyState;
      
      container.innerHTML = `
        <div class="col-span-full flex flex-col items-center justify-center py-16 px-4">
          <div class="w-24 h-24 mb-6 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
            <svg class="w-12 h-12 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <h3 id="empty-state-message" class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
            ${emptyState.message}
          </h3>
          <p id="empty-state-description" class="text-gray-500 dark:text-gray-400 text-center max-w-md">
            ${emptyState.description}
          </p>
        </div>
      `;
      
      // 隐藏分页
      if (paginationContainer) {
        paginationContainer.innerHTML = '';
      }
      
      // 更新统计信息（搜索状态）
      updateStats(0, isSearching);
      return;
    }

    // 确保页码有效
    const totalPages = Math.ceil(tools.length / ITEMS_PER_PAGE);
    if (page < 1) page = 1;
    if (page > totalPages && totalPages > 0) page = totalPages;

    const startIndex = (page - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    const pageTools = tools.slice(startIndex, endIndex);

    container.innerHTML = pageTools
      .map(
        (tool) => `
      <a
        href="${escapeHtml(tool.url)}"
        target="_blank"
        rel="noopener noreferrer"
        class="group relative block p-5 sm:p-6 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-2xl border border-gray-200/60 dark:border-gray-700/60 hover:border-blue-400/60 dark:hover:border-blue-500/40 hover:shadow-xl hover:shadow-blue-500/5 dark:hover:shadow-blue-500/10 transition-all duration-300 ease-out hover:-translate-y-1 hover:scale-[1.02] before:absolute before:inset-0 before:rounded-2xl before:bg-gradient-to-br before:from-blue-50/0 before:via-blue-50/0 before:to-blue-50/0 hover:before:from-blue-50/50 hover:before:via-blue-50/30 hover:before:to-transparent dark:hover:before:from-blue-950/20 dark:hover:before:via-blue-950/10 dark:hover:before:to-transparent before:transition-all before:duration-300 before:-z-10"
      >
        <div class="relative z-10 flex items-start justify-between mb-3 sm:mb-4">
          <div class="flex items-center gap-3 flex-1 min-w-0">
            <span class="flex-shrink-0 w-2.5 h-2.5 bg-gradient-to-br from-emerald-400 via-green-500 to-emerald-600 rounded-full mt-1 shadow-sm shadow-green-500/50 ring-1 ring-green-500/20"></span>
            <h3 class="font-semibold text-gray-900 dark:text-white truncate group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors duration-300 text-base sm:text-lg leading-snug">
              ${escapeHtml(tool.name)}
            </h3>
          </div>
          <button
            class="flex-shrink-0 p-1.5 sm:p-2 text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400 hover:bg-blue-50/80 dark:hover:bg-blue-900/20 rounded-lg transition-all duration-300 active:scale-95 touch-manipulation"
            aria-label="${t('toolCard.openLink')}"
            onclick="event.preventDefault(); event.stopPropagation(); window.open('${escapeHtml(tool.url)}', '_blank', 'noopener,noreferrer');"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </button>
        </div>
        <p class="relative z-10 text-sm sm:text-base text-gray-600 dark:text-gray-400 line-clamp-2 leading-relaxed min-h-[3.25rem] sm:min-h-[3.5rem]">
          ${escapeHtml(tool.description)}
        </p>
      </a>
    `
      )
      .join('');

    // 更新统计信息（根据是否在搜索状态显示不同文本）
    updateStats(tools.length, isSearching);
    // 更新分页
    updatePagination(page, totalPages, updateURL);
    
    // 滚动到顶部，模拟页面刷新效果
    scrollToTop();
  }
  
  // 滚动到顶部（模拟页面刷新效果）
  function scrollToTop() {
    // 立即滚动到顶部（不等待动画）
    window.scrollTo(0, 0);
    
    // 添加轻微的视觉反馈，模拟页面刷新
    const main = document.querySelector('main');
    if (main) {
      // 快速淡出再淡入
      main.style.transition = 'opacity 0.15s ease-out';
      main.style.opacity = '0.7';
      
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          main.style.transition = 'opacity 0.2s ease-in';
          main.style.opacity = '1';
          
          // 清理样式
          setTimeout(() => {
            main.style.transition = '';
            main.style.opacity = '';
          }, 200);
        });
      });
    }
  }

  // 更新统计信息
  function updateStats(total, isSearching = false) {
    const statsText = document.getElementById('stats-text');
    if (statsText) {
      const locale = getLocale();
      const statsLabel = isSearching 
        ? t('page.statsSearch')
        : t('page.stats');
      
      statsText.innerHTML = `<span class="inline-flex items-center gap-2">
        <span class="px-2.5 py-1 rounded-md bg-gray-100 dark:bg-gray-800 text-sm font-medium text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700">${statsLabel}</span>
        <span id="total-count" class="font-semibold text-gray-900 dark:text-white">${total}</span>
        <span>${t('page.items')}</span>
      </span>`;
    }
  }

  // 更新分页
  function updatePagination(page, totalPages, updateURL = true) {
    currentPage = page;
    
    const paginationContainer = document.getElementById('pagination-container');
    if (!paginationContainer) return;
    
    // 如果总页数为0或工具列表为空，隐藏分页
    if (totalPages === 0 || filteredTools.length === 0) {
      paginationContainer.innerHTML = '';
      return;
    }
    
    // 更新 URL 参数
    if (updateURL) {
      updateURLParam('page', page);
    }

    // 创建分页容器
    const paginationDiv = document.createElement('div');
    paginationDiv.className = 'flex flex-col sm:flex-row items-center justify-between gap-4 sm:gap-0 mt-8 sm:mt-12 pt-6 sm:pt-8 border-t border-gray-200/60 dark:border-gray-800/60';
    
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'flex gap-3';
    
    const pageInfo = document.createElement('div');
    pageInfo.id = 'pagination-page-info';
    pageInfo.className = 'text-sm sm:text-base font-medium text-gray-600 dark:text-gray-400';
    pageInfo.innerHTML = `${t('pagination.page')} <span class="font-semibold text-gray-900 dark:text-white">${page}</span> / <span class="font-semibold text-gray-900 dark:text-white">${totalPages}</span>`;
    
    // 创建上一页按钮
    const prevBtn = document.createElement('button');
    prevBtn.id = 'prev-page';
    prevBtn.className = 'inline-flex items-center justify-center px-4 py-2 sm:px-5 sm:py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 hover:shadow-sm active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:shadow-none dark:disabled:hover:bg-gray-800 touch-manipulation';
    prevBtn.disabled = page === 1;
    
    const prevText = document.createElement('span');
    prevText.id = 'prev-page-text';
    prevText.textContent = t('pagination.prev');
    
    prevBtn.appendChild(prevText);
    
    // 创建下一页按钮
    const nextBtn = document.createElement('button');
    nextBtn.id = 'next-page';
    nextBtn.className = 'inline-flex items-center justify-center px-4 py-2 sm:px-5 sm:py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 hover:shadow-sm active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:shadow-none dark:disabled:hover:bg-gray-800 touch-manipulation';
    nextBtn.disabled = page === totalPages;
    
    const nextText = document.createElement('span');
    nextText.id = 'next-page-text';
    nextText.textContent = t('pagination.next');
    
    nextBtn.appendChild(nextText);
    
    // 绑定事件
    prevBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (currentPage > 1) {
        const isSearching = currentQuery !== '';
        renderTools(filteredTools, currentPage - 1, true, isSearching);
      }
    });
    
    nextBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const currentTotalPages = Math.ceil(filteredTools.length / ITEMS_PER_PAGE);
      if (currentPage < currentTotalPages) {
        const isSearching = currentQuery !== '';
        renderTools(filteredTools, currentPage + 1, true, isSearching);
      }
    });
    
    buttonContainer.appendChild(prevBtn);
    buttonContainer.appendChild(nextBtn);
    paginationDiv.appendChild(pageInfo);
    paginationDiv.appendChild(buttonContainer);
    
    // 清空并更新容器
    paginationContainer.innerHTML = '';
    paginationContainer.appendChild(paginationDiv);
  }

  // 搜索相关变量
  let selectedIndex = -1;
  let suggestions = [];
  let currentQuery = '';

  // 高亮匹配文本
  function highlightText(text, query) {
    if (!query || !text) return escapeHtml(text);
    
    const escapedText = escapeHtml(text);
    const escapedQuery = escapeHtml(query);
    const regex = new RegExp(`(${escapedQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return escapedText.replace(regex, '<span class="highlight">$1</span>');
  }

  // 执行搜索（应用到结果列表）
  function performSearch(query) {
    if (!fuse) {
      console.warn('Fuse.js not initialized yet');
      return;
    }

    currentQuery = query.trim();

    if (currentQuery === '') {
      filteredTools = [...toolsData];
    } else {
      try {
        const results = fuse.search(currentQuery);
        filteredTools = results.map((result) => result.item);
      } catch (error) {
        console.error('Search error:', error);
        filteredTools = [...toolsData];
      }
    }

    // 搜索时重置到第一页并更新 URL
    currentPage = 1;
    updateURLParam('page', null);
    renderTools(filteredTools, 1, false);
  }

  // 显示搜索建议
  function showSuggestions(query) {
    if (!fuse) return;

    const suggestionsContainer = document.getElementById('search-suggestions');
    const suggestionsList = document.getElementById('suggestions-list');
    
    if (!suggestionsContainer || !suggestionsList) return;

    if (!query || query.trim() === '') {
      suggestionsContainer.classList.add('hidden');
      suggestions = [];
      selectedIndex = -1;
      return;
    }

    try {
      const results = fuse.search(query, { limit: 8 });
      suggestions = results.map((result) => result.item);

      if (suggestions.length === 0) {
        suggestionsList.innerHTML = `
          <div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 text-center">
            ${t('search.noResults')}
          </div>
        `;
        suggestionsContainer.classList.remove('hidden');
      } else {
        suggestionsList.innerHTML = suggestions
          .map(
            (tool, index) => `
          <div
            class="suggestion-item px-3 py-2 cursor-pointer"
            data-index="${index}"
            data-name="${escapeHtml(tool.name)}"
          >
            <div class="suggestion-content">
              <div class="suggestion-icon">
                <svg class="w-4 h-4 text-gray-400 dark:text-gray-500 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <div class="suggestion-text">
                <div class="suggestion-title text-gray-900 dark:text-gray-100">
                  ${highlightText(tool.name, query)}
                </div>
                <div class="suggestion-description text-gray-600 dark:text-gray-400 line-clamp-1">
                  ${highlightText(tool.description, query)}
                </div>
              </div>
            </div>
          </div>
        `
          )
          .join('');

        // 绑定点击事件
        suggestionsList.querySelectorAll('.suggestion-item').forEach((item, index) => {
          item.addEventListener('click', () => {
            selectSuggestion(index);
          });
        });

        suggestionsContainer.classList.remove('hidden');
        selectedIndex = -1;
      }
    } catch (error) {
      console.error('Suggestions error:', error);
      suggestionsContainer.classList.add('hidden');
    }
  }

  // 选择建议
  function selectSuggestion(index) {
    if (index < 0 || index >= suggestions.length) return;

    const tool = suggestions[index];
    const searchInput = document.getElementById('search-input');
    
    if (searchInput) {
      searchInput.value = tool.name;
      performSearch(tool.name);
      hideSuggestions();
      searchInput.blur();
    }
  }

  // 隐藏建议
  function hideSuggestions() {
    const suggestionsContainer = document.getElementById('search-suggestions');
    if (suggestionsContainer) {
      suggestionsContainer.classList.add('hidden');
    }
    selectedIndex = -1;
  }

  // 更新选中项样式
  function updateSelectedSuggestion() {
    const items = document.querySelectorAll('.suggestion-item');
    items.forEach((item, index) => {
      if (index === selectedIndex) {
        item.classList.add('active');
        item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      } else {
        item.classList.remove('active');
      }
    });
  }

  // 绑定搜索功能
  function bindSearchEvents() {
    const searchInput = document.getElementById('search-input');
    const searchClear = document.getElementById('search-clear');
    const searchContainer = document.getElementById('search-container');

    if (!searchInput) {
      setTimeout(bindSearchEvents, 100);
      return;
    }

    // 输入事件 - 显示建议
    let inputTimeout;
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value;
      
      // 显示/隐藏清除按钮
      if (searchClear) {
        if (query.trim()) {
          searchClear.classList.remove('hidden');
        } else {
          searchClear.classList.add('hidden');
        }
      }

      clearTimeout(inputTimeout);
      inputTimeout = setTimeout(() => {
        showSuggestions(query);
      }, 150);
    });

    // 键盘事件
    searchInput.addEventListener('keydown', (e) => {
      const suggestionsContainer = document.getElementById('search-suggestions');
      const isVisible = suggestionsContainer && !suggestionsContainer.classList.contains('hidden');

      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          if (isVisible && suggestions.length > 0) {
            selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
            updateSelectedSuggestion();
          }
          break;
        case 'ArrowUp':
          e.preventDefault();
          if (isVisible && suggestions.length > 0) {
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelectedSuggestion();
          }
          break;
        case 'Enter':
          e.preventDefault();
          if (isVisible && selectedIndex >= 0 && selectedIndex < suggestions.length) {
            selectSuggestion(selectedIndex);
          } else {
            performSearch(searchInput.value);
            hideSuggestions();
          }
          break;
        case 'Escape':
          hideSuggestions();
          searchInput.blur();
          break;
      }
    });

    // 聚焦事件
    searchInput.addEventListener('focus', () => {
      if (searchInput.value.trim()) {
        showSuggestions(searchInput.value);
      }
    });

    // 清除按钮
    if (searchClear) {
      searchClear.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        searchInput.value = '';
        searchInput.focus();
        searchClear.classList.add('hidden');
        performSearch('');
        hideSuggestions();
      });
    }

    // 点击外部关闭建议
    document.addEventListener('click', (e) => {
      if (searchContainer && !searchContainer.contains(e.target)) {
        hideSuggestions();
      }
    });

    // 键盘快捷键 ⌘K / Ctrl+K
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
        if (searchInput.value.trim()) {
          showSuggestions(searchInput.value);
        }
      }
    });
  }

  // 更新空状态文本（用于语言切换）
  function updateEmptyStateText(locale) {
    const messageEl = document.getElementById('empty-state-message');
    const descEl = document.getElementById('empty-state-description');
    
    if (messageEl && descEl) {
      const emptyState = translations[locale]?.emptyState || translations.zh.emptyState;
      messageEl.textContent = emptyState.message;
      descEl.textContent = emptyState.description;
    }
  }

  // 监听语言变更事件
  window.addEventListener('localechange', function(e) {
    const locale = (e.detail && e.detail.locale) ? e.detail.locale : getLocale();
    // 更新空状态文本
    updateEmptyStateText(locale);
    // 如果当前显示的是空状态，重新渲染以更新文本
    const container = document.getElementById('tools-container');
    if (container && filteredTools.length === 0) {
      const isSearching = currentQuery !== '';
      renderTools(filteredTools, currentPage, false, isSearching);
    }
  });

  // 初始化
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOMContentLoaded - Initializing...');
    
    // 初始化 Fuse.js
    const fuseInitialized = await initFuse();
    if (!fuseInitialized) {
      console.error('Failed to initialize Fuse.js');
    }

    // 从 URL 读取页码（与服务端保持一致）
    const urlPage = getURLParam('page');
    if (urlPage && urlPage > 0) {
      currentPage = urlPage;
    } else {
      // 如果没有 URL 参数，从服务端渲染的页码读取
      const paginationContainer = document.getElementById('pagination-container');
      if (paginationContainer) {
        const pageInfo = paginationContainer.querySelector('#pagination-page-info');
        if (pageInfo) {
          // 使用更通用的正则匹配数字模式，支持多语言
          const match = pageInfo.textContent.match(/(\d+)\s*\/\s*\d+/);
          if (match) {
            currentPage = parseInt(match[1], 10);
          }
        }
      }
    }

    // 绑定搜索功能
    bindSearchEvents();

    // 监听浏览器前进/后退事件
    window.addEventListener('popstate', (e) => {
      const urlPage = getURLParam('page');
      const page = urlPage && urlPage > 0 ? urlPage : 1;
      currentPage = page;
      const isSearching = currentQuery !== '';
      renderTools(filteredTools, page, false, isSearching); // 不更新 URL，因为浏览器已经更新了
    });

    // 确保当前页码与 URL 同步
    const totalPages = Math.ceil(filteredTools.length / ITEMS_PER_PAGE);
    const currentURLPage = getURLParam('page') || 1;
    
    // 如果 URL 中的页码与当前页码不一致，或者需要重新渲染分页
    if (currentURLPage !== currentPage) {
      currentPage = Math.min(currentURLPage, totalPages || 1);
      const isSearching = currentQuery !== '';
      renderTools(filteredTools, currentPage, false, isSearching); // 不更新 URL，因为 URL 已经正确
    } else {
      // 即使页码一致，也要重新创建分页按钮以确保事件绑定正确
      updatePagination(currentPage, totalPages, false);
      // 更新统计信息显示
      const isSearching = currentQuery !== '';
      updateStats(filteredTools.length, isSearching);
    }
  });
</script>
